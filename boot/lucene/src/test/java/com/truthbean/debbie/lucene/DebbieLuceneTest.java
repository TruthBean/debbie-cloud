/**
 * Copyright (c) 2021 TruthBean(Rogar·Q)
 * Debbie is licensed under Mulan PSL v2.
 * You can use this software according to the terms and conditions of the Mulan PSL v2.
 * You may obtain a copy of Mulan PSL v2 at:
 * http://license.coscl.org.cn/MulanPSL2
 * THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY OR FIT FOR A PARTICULAR PURPOSE.
 * See the Mulan PSL v2 for more details.
 */
package com.truthbean.debbie.lucene;

import com.truthbean.debbie.bean.BeanInject;
import com.truthbean.transformer.text.DoubleArrayTransformer;
import com.truthbean.debbie.jdbc.datasource.DataSourceFactory;
import com.truthbean.debbie.jdbc.repository.DynamicRepository;
import com.truthbean.debbie.test.annotation.DebbieApplicationTest;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.time.LocalDate;
import java.util.List;

/**
 * @author TruthBean/Rogar·Q
 * @since 0.1.0
 * Created on 2020-08-13 11:39
 */
@DebbieApplicationTest
public class DebbieLuceneTest {

    private final LuceneHelper helper = new LuceneHelper();

    public DebbieLuceneTest() throws IOException {
    }

    @Test
    void createIndex(@BeanInject("dataSourceFactory") DataSourceFactory factory) throws IOException {
        var transaction = factory.getTransaction();
        List<Feature> list = DynamicRepository.query(transaction)
                .select("id", "createTime as date", "feature")
                .from("face")
                .orderBy("id").desc()
                .toList(Feature.class);
        for (Feature feature : list) {
            helper.createIndex(feature);
        }
    }

    @Test
    void createTestIndex() throws IOException {
        helper.createTestIndex();
    }

    @Test
    void queryIndex() throws IOException {
        var date = LocalDate.of(2020, 8, 7);
        helper.queryIndex(date);
        System.out.println("-----------------------------------------------------------------------------");
        // helper.queryIndex();
    }

    @Test
    void search() throws IOException {
        DoubleArrayTransformer transformer = DoubleArrayTransformer.getInstance();
        double[] feature = transformer.reverse("[0.028857801, 0.09019281, -0.037625693, 0.0049748807, -0.046538975, 0.07983135, -0.018106151, 0.053235356, 0.021481792, -0.055935293, 0.00027257914, -0.036475662, -0.003465028, -0.0029871373, 0.05429716, 0.024918295, 0.029942244, -0.06304369, 0.015820011, -0.023050187, 0.026262403, 0.031924825, 0.016757764, -0.020253051, 0.06509328, 0.018716631, -0.038648702, -0.007619059, -0.040406633, 0.011773407, 0.015233575, -0.044728365, 0.00009081801, 0.07626919, 0.020503046, 0.04310388, -0.008048969, 0.09215045, -0.06235309, 0.022073144, 0.023727322, -0.06920542, -0.01755804, 0.008018887, -0.0068137613, -0.019343814, 0.01889528, -0.009039123, -0.055537254, -0.029247522, 0.045991518, 0.04386166, -0.018775608, 0.04907303, -0.046232767, -0.02702, -0.06851193, -0.015826475, -0.027898997, 0.04090958, 0.08621733, 0.0422365, 0.03477014, 0.031682063, -0.02097453, -0.011991293, -0.028058933, 0.0011384407, 0.007443317, 0.06380543, 0.0029523703, -0.039536864, -0.08043275, 0.016108494, -0.06211178, -0.04002854, -0.05642995, 0.0028532443, 0.01784991, -0.024277957, 0.0004045589, 0.026583621, -0.021518063, -0.120604984, 0.073397934, 0.019361569, -0.0091805365, -0.047884062, -0.0011766686, -0.014777253, 0.09136102, -0.023577033, 0.022091866, -0.03572379, 0.0100530265, 0.032426473, 0.098255105, -0.043014597, -0.042924486, 0.074935414, 0.045419585, 0.070576474, -0.10847868, -0.037308954, 0.09545086, -0.052988134, -0.022933934, 0.029833324, 0.023685487, 0.029207727, -0.023713924, 0.030167269, -0.03485176, -0.048485138, -0.012131537, -0.009822216, 0.019595902, 0.0055326703, -0.048576504, 0.022577746, 0.029601842, 0.032946736, 0.06194849, 0.011526004, 0.029450817, 0.03326496, -0.09591649, -0.00045995254, 0.050612215, 0.02737192, -0.008438718, 0.08909039, 0.016921014, -0.11624949, -0.067425616, -0.14654149, -0.039099928, 0.04899352, -0.024299487, 0.037263352, 0.036292654, 0.016757542, -0.07600385, 0.0150385285, -0.03888815, -0.08252159, 0.007292974, 0.035770725, 0.04979373, 0.007638159, -0.014816562, 0.000160188, 0.06666392, 0.06113325, 0.054658826, 0.020940417, 0.008885935, -0.052531224, -0.054730263, 0.05701644, -0.052275132, -0.0054779295, -0.054850455, 0.013105092, -0.0016981306, 0.020562882, -0.009590718, 0.03770318, -0.0008124572, -0.07488909, 0.032249063, 0.043763205, -0.051313598, -0.024830522, -0.10481688, 0.024427036, -0.012009326, 0.05267835, 0.062277675, 0.027122753, 0.1036773, -0.039564677, 0.016751377, -0.03285809, -0.03934124, 0.0026680422, 0.041486815, 0.008510561, 0.043645535, -0.006007412, 0.0047765314, -0.062038846, -0.0035823365, -0.031736847, 0.044273686, 0.012419403, 0.017719267, 0.07276605, -0.030519031, -0.008207861, 0.007077782, -0.009119606, -0.053088102, -0.008015035, -0.061314967, 0.005866693, 0.012747002, -0.016481055, 0.04647222, 0.039775368, 0.03527084, 0.004672073, -0.035918612, -0.04614858, 0.011556273, -0.03623936, -0.027512863, -0.036000244, 0.021811476, 0.0075088413, -0.03313129, 0.068265654, -0.09467621, -0.07869652, 0.013943164, 0.06947545, 0.017372798, -0.0009267154, -0.014853065, -0.018013328, 0.01905992, 0.03463947, -0.010078795, -0.023203865, -0.049825355, 0.08005824, 0.0016768964, 0.024931777, 0.020652507, 0.001043606, 0.041444514, 0.017307505, 0.050842274, -0.033122018, -0.01343188, -0.00025360708, -0.021473411, -0.06791506, -0.023813773, 0.060574725, 0.02251967, 0.020134717, 0.074576624, 0.041690134, -0.011529973, 0.035221014, -0.008359224, -0.04867871, 0.04524233, -0.011896028, 0.03163077, -0.033500705, 0.012353058, 0.035061862, 0.08423733, 0.05581154, 0.051637493, 0.050289147, -0.03404423, -0.029398205, 0.034241263, 0.015099402, 0.043770224, 0.080394804, -0.0072027585, 0.0036633874, -0.048210684, 0.015796768, -0.0124250045, 0.07128623, -0.030323323, 0.026254859, 0.0259257, 0.061477136, -0.0064137545, -0.027566379, -0.04020914, 0.05026401, -0.05292659, -0.01607741, -0.061269056, 0.04592449, -0.048896447, 0.0138027035, -0.0036298246, 0.0156957, -0.028885853, 0.062235374, -0.040075533, 0.084875114, 0.036373004, 0.06900402, -0.03284678, 0.044441797, -0.09883265, 0.021933114, 0.023330886, -0.004324661, -0.024862383, 0.011082188, -0.020217678, -0.05006269, 0.051031567, -0.06249186, 0.04478327, -0.040982272, 0.002071762, 0.0067307563, -0.0023187525, 0.0120944325, -0.048914723, 0.054638937, 0.05853176, -0.044882603, 0.029429382, -0.092499465, -0.0049713687, 0.04716996, 0.08814929, -0.036284562, 0.060932867, -0.076329194, -0.012573252, -0.0476061, -0.009169546, -0.11178216, 0.0472508, 0.05528867, 0.07666654, 0.01879635, -0.02611731, 0.09522022, 0.019128818, -0.018720489, 0.004701871, 0.047387306, -0.0105693955, -0.043763112, 0.017778963, -0.0036012502, 0.015619777, 0.0028572264, 0.039481007, -0.10525367, -0.00025524796, -0.0546512, -0.048708417, 0.01452822, 0.061784033, -0.036308434, -0.031024298, 0.033698115, 0.026068639, -0.061993808, -0.068367615, -0.043623865, 0.06715741, 0.050916336, -0.006494404, -0.038901806, -0.02264831, -0.014480787, 0.04528596, -0.008498582, 0.0218801, -0.035297707, 0.037740532, -0.02422361, 0.030659597, 0.008490509, -0.040917385, -0.026892707, -0.017606033, 0.05042136, -0.01204143, 0.0766003, 0.07139711, -0.01816247, 0.020344524, 0.012765236, 0.03386617, -0.009049724, -0.094911665, -0.011996534, 0.008326993, -0.08661465, -0.059978772, -0.00904814, -0.007967033, 0.038135685, -0.0018970069, 0.04753205, 0.002269554, -0.017136652, 0.018049086, 0.021587994, -0.035770927, -0.008961895, -0.010980837, 0.013741286, -0.06510884, -0.0044615357, 0.08905589, -0.008330382, 0.049866136, 0.00961878, 0.0022256093, -0.03711549, -0.026691567, 0.11656887, -0.00813848, -0.046066545, 0.05992991, 0.007920775, 0.0258255, 0.017599573, 0.012542105, 0.016179241, -0.012882092, 0.039872777, 0.04740992, -0.0004157385, -0.019411685, -0.048585244, -0.019866513, -0.03309627, 0.0048727705, 0.0033054466, -0.054934625, -0.023620056, 0.0130168665, 0.044671435, 0.03574324, 0.029355975, -0.058133602, -0.000014898979, 0.013666918, -0.04852634, 0.048582047, 0.08486894, -0.07219276, 0.00014847089, 0.0543836, 0.024785625, -0.020072617, -0.003383091, -0.048930448, 0.08855957, 0.009494602, -0.022353137, -0.1234862, -0.024158893, 0.047353, 0.07723784, -0.041187868, 0.034976795, -0.057682388, -0.047120336, -0.062438674, -0.04016383, -0.06796543, 0.008797502, 0.015460857, -0.028432837, 0.022265831, -0.071924955, 0.014639685, -0.010334103, 0.062028915, -0.04856394, -0.05229837, 0.03315005, -0.0054918462, -0.032502726, 0.024922794, -0.05275686, -0.018921949, -0.031010348, -0.04644051, 0.06730218, 0.059549212, 0.037175283, -0.0037571443, 0.07804787, -0.006101066, -0.059639946, -0.000030793624, 0.029785775, 0.056829583, 0.074256815, -0.0036175102, -0.083713956, -0.032098193, -0.02267503, 0.07271118, 0.0052532535, 0.007981266, -0.04098549, -0.022807704, -0.005531115, 0.024803188, 0.047687136]");
        DistanceFeature distanceFeature = helper.queryIndex(feature);
        System.out.println(distanceFeature);
    }
}
